<?xml version="1.0" encoding="utf-8" ?>
<Page
    x:Class="GAutoSwitch.UI.Views.SettingsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:GAutoSwitch.Core.Models"
    xmlns:viewmodels="using:GAutoSwitch.UI.ViewModels"
    mc:Ignorable="d"
    Background="Transparent"
    Loaded="Page_Loaded"
    Unloaded="Page_Unloaded">

    <Grid>
        <ScrollViewer>
            <StackPanel
                Padding="56,24,56,24"
                MaxWidth="1000"
                HorizontalAlignment="Stretch">

                <!-- Page Header -->
                <TextBlock
                    Text="Settings"
                    Style="{StaticResource PageHeaderStyle}"/>
                <TextBlock
                    Text="Configure audio device switching behavior"
                    Style="{StaticResource CaptionTextBlockStyle}"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                    Margin="0,0,0,8"/>

                <!-- Headphone Status Card -->
                <Border
                    x:Name="HeadsetStatusCard"
                    Style="{StaticResource HeadsetStatusCardStyle}"
                    Margin="0,16,0,0">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Headphone Icon -->
                        <Grid Grid.Column="0" Margin="0,0,16,0" VerticalAlignment="Center">
                            <FontIcon
                                x:Name="HeadsetIcon"
                                Glyph="{x:Bind HeadsetViewModel.StatusIcon, Mode=OneWay}"
                                FontSize="32"
                                Foreground="{x:Bind HeadsetViewModel.StatusColor, Mode=OneWay}"/>
                        </Grid>

                        <!-- Product Name and Status -->
                        <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="2">
                            <TextBlock
                                Text="{x:Bind HeadsetViewModel.ProductName, Mode=OneWay}"
                                Style="{StaticResource SubtitleTextBlockStyle}"
                                FontWeight="SemiBold"/>
                            <TextBlock
                                Text="{x:Bind HeadsetViewModel.StatusText, Mode=OneWay}"
                                Style="{StaticResource CaptionTextBlockStyle}"
                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                        </StackPanel>

                        <!-- Status Indicator -->
                        <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center" Margin="16,0">
                            <!-- Static dot (hidden when switching) -->
                            <Ellipse
                                Width="10"
                                Height="10"
                                Fill="{x:Bind HeadsetViewModel.StatusDotColor, Mode=OneWay}"
                                Visibility="{x:Bind HeadsetViewModel.IsSwitching, Mode=OneWay, Converter={StaticResource BoolToVisibilityInverseConverter}}"/>
                            <!-- Spinning ring (shown when switching) -->
                            <ProgressRing
                                Width="16"
                                Height="16"
                                IsActive="{x:Bind HeadsetViewModel.IsSwitching, Mode=OneWay}"
                                Visibility="{x:Bind HeadsetViewModel.IsSwitching, Mode=OneWay}"/>
                            <TextBlock
                                Text="{x:Bind HeadsetViewModel.StatusText, Mode=OneWay}"
                                VerticalAlignment="Center"
                                Foreground="{x:Bind HeadsetViewModel.StatusColor, Mode=OneWay}"
                                FontWeight="SemiBold"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Device Override Warning -->
                <InfoBar
                    x:Name="DeviceOverrideInfoBar"
                    IsOpen="{x:Bind ViewModel.HasDeviceOverride, Mode=OneWay}"
                    Severity="Warning"
                    Title="Audio devices don't match configuration"
                    Margin="0,8,0,0"
                    IsClosable="False">
                    <InfoBar.Content>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Spacing="4">
                                <TextBlock Style="{StaticResource CaptionTextBlockStyle}">
                                    <Run Text="Expected speaker: "/><Run Text="{x:Bind ViewModel.ExpectedSpeaker, Mode=OneWay}" FontWeight="SemiBold"/>
                                </TextBlock>
                                <TextBlock Style="{StaticResource CaptionTextBlockStyle}">
                                    <Run Text="Expected microphone: "/><Run Text="{x:Bind ViewModel.ExpectedMicrophone, Mode=OneWay}" FontWeight="SemiBold"/>
                                </TextBlock>
                            </StackPanel>
                            <Button
                                Grid.Column="1"
                                Content="Apply Config"
                                Style="{StaticResource AccentButtonStyle}"
                                Command="{x:Bind ViewModel.SyncToCurrentOutputCommand}"
                                VerticalAlignment="Center"
                                Margin="16,0,0,0"/>
                        </Grid>
                    </InfoBar.Content>
                </InfoBar>

                <!-- Audio Devices Section -->
                <TextBlock
                    Text="Audio Devices"
                    Style="{StaticResource SettingsSectionHeaderStyle}"/>

                <!-- Current Windows Defaults Card -->
                <Border Style="{StaticResource SettingsCardStyle}" Margin="0,0,0,8">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <FontIcon Grid.Column="0" Glyph="&#xE767;" FontSize="20" Margin="0,0,16,0" VerticalAlignment="Center"/>

                        <StackPanel Grid.Column="1" Spacing="4">
                            <TextBlock Text="Current Windows Defaults" Style="{StaticResource SubtitleTextBlockStyle}"/>
                            <StackPanel Orientation="Horizontal" Spacing="24">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <FontIcon Glyph="&#xE767;" FontSize="14" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                    <TextBlock Text="{x:Bind ViewModel.CurrentDefaultSpeaker, Mode=OneWay}"
                                               Style="{StaticResource CaptionTextBlockStyle}"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <FontIcon Glyph="&#xE720;" FontSize="14" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                    <TextBlock Text="{x:Bind ViewModel.CurrentDefaultMicrophone, Mode=OneWay}"
                                               Style="{StaticResource CaptionTextBlockStyle}"/>
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>

                        <!-- Match indicator -->
                        <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">
                            <!-- Static icon (hidden when switching) -->
                            <FontIcon
                                Glyph="{x:Bind ViewModel.MatchStatusIcon, Mode=OneWay}"
                                FontSize="16"
                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                Visibility="{x:Bind ViewModel.IsSwitchingDevices, Mode=OneWay, Converter={StaticResource BoolToVisibilityInverseConverter}}"/>
                            <!-- Spinning ring (shown when switching) -->
                            <ProgressRing
                                Width="16"
                                Height="16"
                                IsActive="{x:Bind ViewModel.IsSwitchingDevices, Mode=OneWay}"
                                Visibility="{x:Bind ViewModel.IsSwitchingDevices, Mode=OneWay}"/>
                            <TextBlock
                                Text="{x:Bind ViewModel.MatchStatusText, Mode=OneWay}"
                                Style="{StaticResource CaptionTextBlockStyle}"
                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Two-Column Layout for Wireless/Wired -->
                <Grid Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="16"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Wireless Devices Column -->
                    <Border Grid.Column="0" Style="{StaticResource SettingsCardStyle}">
                        <StackPanel Spacing="16">
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <FontIcon Glyph="&#xE703;" FontSize="20"/>
                                <TextBlock Text="Wireless Devices" Style="{StaticResource SubtitleTextBlockStyle}"/>
                            </StackPanel>

                            <!-- Wireless Speaker -->
                            <StackPanel Spacing="4">
                                <TextBlock Text="Speaker" Style="{StaticResource CaptionTextBlockStyle}"/>
                                <ComboBox
                                    x:Name="WirelessSpeakerComboBox"
                                    HorizontalAlignment="Stretch"
                                    MinWidth="200"
                                    ItemsSource="{x:Bind ViewModel.PlaybackDevices, Mode=OneWay}"
                                    SelectedItem="{x:Bind ViewModel.SelectedWirelessSpeaker, Mode=TwoWay}"
                                    PlaceholderText="Select speaker...">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate x:DataType="models:AudioDevice">
                                            <TextBlock Text="{x:Bind Name}" TextTrimming="CharacterEllipsis"/>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </StackPanel>

                            <!-- Wireless Microphone -->
                            <StackPanel Spacing="4">
                                <TextBlock Text="Microphone" Style="{StaticResource CaptionTextBlockStyle}"/>
                                <ComboBox
                                    x:Name="WirelessMicrophoneComboBox"
                                    HorizontalAlignment="Stretch"
                                    MinWidth="200"
                                    ItemsSource="{x:Bind ViewModel.CaptureDevices, Mode=OneWay}"
                                    SelectedItem="{x:Bind ViewModel.SelectedWirelessMicrophone, Mode=TwoWay}"
                                    PlaceholderText="Select microphone...">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate x:DataType="models:AudioDevice">
                                            <TextBlock Text="{x:Bind Name}" TextTrimming="CharacterEllipsis"/>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Wired Devices Column (Fallback) -->
                    <Border Grid.Column="2" Style="{StaticResource SettingsCardStyle}">
                        <StackPanel Spacing="16">
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <FontIcon Glyph="&#xE7F5;" FontSize="20"/>
                                <TextBlock Text="Wired Devices (Fallback)" Style="{StaticResource SubtitleTextBlockStyle}"/>
                            </StackPanel>

                            <!-- Wired Speaker -->
                            <StackPanel Spacing="4">
                                <TextBlock Text="Speaker" Style="{StaticResource CaptionTextBlockStyle}"/>
                                <ComboBox
                                    x:Name="WiredSpeakerComboBox"
                                    HorizontalAlignment="Stretch"
                                    MinWidth="200"
                                    ItemsSource="{x:Bind ViewModel.PlaybackDevices, Mode=OneWay}"
                                    SelectedItem="{x:Bind ViewModel.SelectedWiredSpeaker, Mode=TwoWay}"
                                    PlaceholderText="Select speaker...">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate x:DataType="models:AudioDevice">
                                            <TextBlock Text="{x:Bind Name}" TextTrimming="CharacterEllipsis"/>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </StackPanel>

                            <!-- Wired Microphone -->
                            <StackPanel Spacing="4">
                                <TextBlock Text="Microphone" Style="{StaticResource CaptionTextBlockStyle}"/>
                                <ComboBox
                                    x:Name="WiredMicrophoneComboBox"
                                    HorizontalAlignment="Stretch"
                                    MinWidth="200"
                                    ItemsSource="{x:Bind ViewModel.CaptureDevices, Mode=OneWay}"
                                    SelectedItem="{x:Bind ViewModel.SelectedWiredMicrophone, Mode=TwoWay}"
                                    PlaceholderText="Select microphone...">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate x:DataType="models:AudioDevice">
                                            <TextBlock Text="{x:Bind Name}" TextTrimming="CharacterEllipsis"/>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </Grid>

                <!-- Manual Sync Card (shown when config matches, for manual override) -->
                <Border
                    Style="{StaticResource SettingsCardStyle}"
                    Margin="0,0,0,8"
                    Visibility="{x:Bind ViewModel.IsUsingConfiguredDevice, Mode=OneWay}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <FontIcon
                            Grid.Column="0"
                            Glyph="&#xE8CB;"
                            FontSize="20"
                            Margin="0,0,16,0"
                            VerticalAlignment="Center"/>

                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <TextBlock Text="Manual Sync"/>
                            <TextBlock
                                Text="Force apply the configured devices to Windows"
                                Style="{StaticResource CaptionTextBlockStyle}"
                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                        </StackPanel>

                        <Button
                            Grid.Column="2"
                            Content="Apply"
                            Command="{x:Bind ViewModel.SyncToCurrentOutputCommand}"
                            VerticalAlignment="Center"/>
                    </Grid>
                </Border>

                <!-- Behavior Section -->
                <TextBlock
                    Text="Behavior"
                    Style="{StaticResource SettingsSectionHeaderStyle}"/>

                <!-- Start Minimized Card -->
                <Border Style="{StaticResource SettingsCardStyle}" Margin="0,0,0,8">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <FontIcon
                            Grid.Column="0"
                            Glyph="&#xE921;"
                            FontSize="20"
                            Margin="0,0,16,0"
                            VerticalAlignment="Center"/>

                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <TextBlock Text="Start Minimized"/>
                            <TextBlock
                                Text="Launch the app minimized to system tray"
                                Style="{StaticResource CaptionTextBlockStyle}"
                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                        </StackPanel>

                        <ToggleSwitch
                            Grid.Column="2"
                            IsOn="{x:Bind ViewModel.StartMinimized, Mode=TwoWay}"
                            VerticalAlignment="Center"/>
                    </Grid>
                </Border>

                <!-- Launch on Startup Card -->
                <Border Style="{StaticResource SettingsCardStyle}" Margin="0,0,0,8">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <FontIcon
                            Grid.Column="0"
                            Glyph="&#xE7E8;"
                            FontSize="20"
                            Margin="0,0,16,0"
                            VerticalAlignment="Center"/>

                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <TextBlock Text="Launch on Startup"/>
                            <TextBlock
                                Text="Automatically start when Windows starts"
                                Style="{StaticResource CaptionTextBlockStyle}"
                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                        </StackPanel>

                        <ToggleSwitch
                            Grid.Column="2"
                            IsOn="{x:Bind ViewModel.LaunchOnStartup, Mode=TwoWay}"
                            VerticalAlignment="Center"/>
                    </Grid>
                </Border>

            </StackPanel>
        </ScrollViewer>

        <!-- Loading Overlay -->
        <Grid
            Background="{ThemeResource LayerOnMicaBaseAltFillColorDefaultBrush}"
            Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay}">
            <ProgressRing IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}" />
        </Grid>
    </Grid>
</Page>
